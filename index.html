<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>江美城 デジタル御城印 配布ページ</title>

<style>
body {
  font-family: "Yu Mincho", "游明朝", "Hiragino Mincho ProN", "Noto Serif JP", serif;
  background: #f7f6f2;
  color: #222;
  padding: 40px 20px;
}

.container {
  max-width: 820px;
  margin: 0 auto;
}

h1 {
  font-size: 26px;
  margin-bottom: 12px;
}

.lead {
  font-size: 15px;
  line-height: 1.8;
  margin-bottom: 30px;
}

.image-wrapper {
  text-align: center;
}

.image-wrapper img {
  max-width: 600px;
  width: 100%;
  height: auto;
  background: #fff;
  border: 1px solid #ccc;
}

.download {
  text-align: center;
  margin-top: 30px;
}

.download button {
  padding: 12px 30px;
  font-size: 14px;
  background: #333;
  color: #fff;
  border: none;
  cursor: pointer;
}

.download button:hover {
  opacity: 0.85;
}

.note {
  font-size: 13px;
  color: #555;
  margin-top: 25px;
  line-height: 1.7;
}
</style>
</head>

<body>
<div class="container">

<h1>江美城 デジタル御城印</h1>

<p class="lead">
江美城の歴史と姿を伝えるデジタル御城印です。<br>
ダウンロードされる画像には、取得当日の和暦日付が自動で記録されます。
</p>

<div class="image-wrapper">
  <!-- 表示用：日付なし原本 -->
  <img id="gojohin" src="ebicastle.png" alt="江美城 デジタル御城印">
</div>

<div class="download">
  <button id="downloadBtn">デジタル御城印をダウンロード</button>
</div>

<p class="note">
※ 本御城印は個人利用の範囲でお楽しみください。<br>
※ 無断転載・再配布・商用利用はご遠慮ください。
</p>

</div>

<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {

  // ① 画像を fetch で取得
  const response = await fetch("ebicastle.png");
  const blob = await response.blob();

  // ② Blob → Image
  const img = new Image();
  img.src = URL.createObjectURL(blob);

  img.onload = () => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = img.width;
    canvas.height = img.height;

    // 原本描画
    ctx.drawImage(img, 0, 0);

    // 明朝対策
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";

    // 和暦生成
    const wareki = new Intl.DateTimeFormat(
      "ja-JP-u-ca-japanese",
      { era: "long", year: "numeric", month: "numeric", day: "numeric" }
    ).format(new Date());

    // 年・月・日 分解
    const lines = [
      wareki.match(/^(.*年)/)[1],
      "",
      wareki.match(/年(.*月)/)[1],
      "",
      wareki.match(/月(.*日)/)[1]
    ];

    // 明朝・墨色
    ctx.fillStyle = "#2b2b2b";
    ctx.font =
      "48px 'Yu Mincho','游明朝','Hiragino Mincho ProN','Noto Serif JP',serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "bottom";

    const x = 80;
    let y = canvas.height - 80;

    for (const line of lines) {
      if (!line) {
        y -= 32;
        continue;
      }
      for (const char of line) {
        ctx.fillText(char, x, y);
        y -= 56;
      }
      y -= 24;
    }

// ファイル名
const d = new Date();
const ymd =
  d.getFullYear() +
  String(d.getMonth() + 1).padStart(2, "0") +
  String(d.getDate()).padStart(2, "0");

// DL処理
canvas.toBlob(blob => {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `江美城_デジタル御城印_${ymd}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}, "image/png");

}) // ← ★ イベントを閉じる（1個だけ）


</script>

</body>
</html>
